{% extends "newbase.html" %}
{% block pagetitle %} | {{listing.title}} {% endblock pagetitle %}
{% block content %}
{% load humanize %}

<div x-data="{ selectedImage: '{{ listing.medias.first.file_path }}' }" class="mt-6 grid grid-cols-1 lg:grid-cols-[100px_2fr_1fr]  gap-6 px-2 sm:px-6 lg:px-14">

  <!-- Left: Thumbnails -->
  <div class="flex lg:flex-col gap-4 overflow-x-auto lg:overflow-y-auto max-h-[40rem] ">
    {% for media in listing.medias.all %}
    <img 
      @click="selectedImage = '{{ media.file_path }}'"
      src="{{ media.file_path }}" 
      alt="Thumbnail"
      class="h-20 w-28 lg:w-[10rem] object-cover rounded-lg border-3 border-transparent cursor-pointer hover:border-lime-500 transition duration-300"
      :class="{ 'border-lime-500 shadow-lg': selectedImage === '{{ media.file_path }}' }"
    >
    {% endfor %}
  </div>

  <!-- Center: Main Image Display -->
  <div class="w-full ">
    <img 
      :src="selectedImage" 
      alt="Selected Image" 
      class="w-full h-full sm:h-[40rem] object-cover rounded-xl shadow-lg transition-all duration-300"
    >
  </div>
 
  <!-- Right: Listing Details -->
  <div class="flex flex-col gap-5">

    <!-- Owner / Message / Controls -->
    <div class="flex flex-col sm:flex-row gap-2 justify-between items-center bg-white rounded-lg p-4">
      <div class="flex items-center gap-2">
        <i class="fas fa-user border p-2 rounded-full text-lime-500"></i>
        <span class=" text-sm sm:text-xl font-semibold">{{ listing.user.first_name }} {{ listing.user.last_name }}</span>
      </div>

      {% if user.id != listing.user.id and listing.status %}
      <a href="{% url 'start_conversation' listing_id=listing.id user_id=listing.user_id %}" class="glow-button w-full sm:w-auto text-white bg-secondary  transition px-4 py-2 rounded text-center ">
        <i class="fas fa-comments"></i> Start Chat
      </a>  
      {% endif %}
    </div>

    <!-- Owner Controls -->
    {% if user.id == listing.user.id %}
    <div class="flex flex-col gap-3" x-data="{ showModal: false }">
      <div class="flex gap-2 flex-wrap">
        {% if listing.status %}
        <a href="{% url 'listing-change-status' id=listing.id %}" class="text-white bg-warning hover:bg-warning-hover px-4 py-2 rounded-md text-sm">
          <i class="fa fa-times"></i> Mark as Unavailable
        </a>
        {% else %}
        <a href="{% url 'listing-change-status' id=listing.id %}" class="text-white bg-secondary hover:bg-lime-600 px-4 py-2 rounded-md text-sm">
          <i class="fas fa-check"></i> Mark as Available
        </a>
        {% endif %}
        <a href="{% url 'listing_update' id=listing.id %}" class="text-white bg-secondary hover:bg-lime-600 px-4 py-2 rounded-md text-sm">
          <i class="fas fa-edit"></i> Edit
        </a>
      {% comment %} </div> {% endcomment %}
    {% comment %} </div> {% endcomment %}

    <!-- Delete Confirmation Modal -->
    {% comment %} <div x-data="{ showModal: false }"> {% endcomment %}
      <button @click="showModal = true" class="text-white bg-red-500 hover:bg-red-600 px-4 py-2 rounded-md text-sm">
        <i class="fa fa-trash"></i> Delete
      </button>
    </div>
    
      <!-- Modal Overlay -->
      <div 
        class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
        x-show="showModal"
        x-transition
        style="display: none;"
      >
        <!-- Modal Box -->
        <div 
          class="bg-white rounded-lg p-4 max-w-sm w-full shadow-lg"
          @click.away="showModal = false"
          x-show="showModal"
          x-transition
        >
          <h2 class="text-xl font-semibold text-gray-800 mb-4">Confirm Delete</h2>
          <p class="text-gray-600 mb-6">Are you sure you want to delete this listing? This action cannot be undone.</p>

          <div class="flex justify-end space-x-3">
            <button 
              @click="showModal = false"
              class="px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded"
            >
              Cancel
            </button>
            <form action="{% url 'listing_delete' id=listing.id %}" method="post">
              {% csrf_token %}
              <button @click="showModal = false;" type="submit" class="text-white bg-red-500 hover:bg-red-600 px-4 py-2 rounded-md text-sm">
                <i class="fa fa-trash"></i> Delete
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>
    {% endif %}

    <!-- Listing Info -->
    <div class="bg-white rounded-lg p-4">
      <div>
        <div class="flex items-center gap-2 mb-1">
          <h2 class="text-2xl font-bold">{{ listing.title }}</h2>
          <span class="text-white text-xs font-semibold px-2 py-1 rounded {% if listing.status %} bg-green-400 {% else %} bg-red-400 {% endif %}">
            {% if listing.status %}Available{% else %}Unavailable{% endif %}
          </span>
        </div>
  
        <p class="text-xl font-semibold text-gray-800">ETB {{ listing.price|floatformat:0|intcomma }} <span class="font-light text-base">/month</span></p>
      </div>
  
      <div class="text-sm text-gray-600 space-y-4">
        <div class="flex items-center gap-2">
          <i class="fas fa-map-marker-alt text-lime-600"></i>
          <span>{{ listing.area }}, {{ listing.sub_city }}, {{ listing.city }}</span>
        </div>
        <div class="flex gap-6 mt-2">
          {% comment %} <span><i class="fa fa-home text-lime-600"></i> {{ listing.rooms }} rooms</span> {% endcomment %}
          <span><i class="fa fa-bed text-lime-600"></i> {{ listing.bedrooms }} bedrooms</span>
          <span><i class="fa fa-shower text-lime-600"></i> {{ listing.bathrooms }} bathrooms</span>
        </div>
        <div class="mt-2">
          <span class="font-semibold"><i class="fa fa-phone text-lime-600"></i> {{ listing.phone_number1 }}{% if listing.phone_number2 %}, {{ listing.phone_number2 }}{% endif %}</span>
        </div>
      </div>
    </div>

    <div class=" bg-white rounded-lg p-3">
      <p class="">Amenities</p>
      {% if listing.amenities.all %}
        <ul class="flex flex-wrap gap-3 text-sm text-gray-700">
          {% for amenity in listing.amenities.all %}
            <li class="bg-lime-500 text-white font-semibold px-3 py-1 rounded-full flex items-center gap-2">
              <i class="fa fa-check w-4 h-4 flex items-center justify-center text-lime-500 bg-white rounded-full"></i>
              {{ amenity.name }}
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <p class="text-gray-500">No amenities listed.</p>
      {% endif %}
    </div>

    <div class=" text-gray-700 bg-white rounded-lg p-3">
      {{ listing.desc }}
    </div>

  </div>
</div>

<!-- AlpineJS for image interactivity -->
<script src="//unpkg.com/alpinejs" defer></script>
<script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

{% endblock content %}
